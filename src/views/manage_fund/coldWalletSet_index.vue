<template>
    <div class="coldWalletSet">
        <Card>
            <p slot="title">冷钱包设置
                <Button type="primary" @click="add">添加</Button>
            </p>
            <Table :columns="columns1" :data="data1"></Table>
            <Page :current="curPage" :total="total" @on-change="changePage" style="text-align:center;margin-top:20px;"></Page>  
        </Card>
    </div>
</template>
<script>
import addWallet from './addWallet'
import upWallet from './upWallet'
import util from '../../libs/util'
import fundApi from '../../api/fund'
import updataWaletAddress from './updataWaletAddress'
import addAddress from './addAddress'
    export default {
        data () {
            return {
                curPage: 1,
                total: 0,
                columns1: [
                    {
                        title: '币种',
                        key: 'symbol'
                    },
                    {
                        title: '主链类型',
                        key: 'symbolType',
                        render: (h, params) => {
                            return h('div', this.switchStaus(params.row.symbolType))
                        }
                    },
                    {
                        title: '地址',
                        key: 'address',
                        render: (h, params) => {
                            let o = this.detail(params.row.addressList, h)
                            console.log(params.row.addressList[0].address)
                            return h('Select', {
                                props: {value:o.selValue || params.row.addressList[0].address},
                                on: {
                                    'on-change': (value) => {
                                        params.row.$select_value = value
                                    }
                                }
                            }, o.options)
                        }
                    },
                    {
                        title: ' ',
                        key: 'address',
                        render: (h, params) => {
                            let o = this.detail(params.row.addressList, h)
                            return h('div', [
                                h('Button', {
                                    props: {type: 'primary', size: 'small', disabled: o.valueAll && o.valueAll.enable === null },
                                    style: {marginRight: '10px'},
                                    on: {
                                        click: () => {
                                            let sel = null
                                            let list = params.row.addressList
                                            for (let i=0;i<list.length;i++) {
                                                let d = list[i]
                                                if (params.row.$select_value) {
                                                    if (d.address === params.row.$select_value) {
                                                        sel = d
                                                        break
                                                    }
                                                } else {
                                                    if (d.defaultFlag == 1) {
                                                        sel = d
                                                        break
                                                    }
                                                }
                                            }
                                            if (!sel && list.length) {
                                                sel = list[0]
                                            }
                                           fundApi.updateColdWallet({
                                                walletId: sel.walletId,
                                                version: sel.version,
                                                enable: o.valueAll.enable === 1 ? 0 : 1
                                            }, (res) => {
                                                this.$Message.success({content: '启用成功'})
                                                 this.getAllColdWallet()
                                            }) 
                                             
                                        }
                                    }
                                }, o.valueAll && o.valueAll.enable === 1 ? '禁用': '启用'),
                                h('Button', {
                                    props: {type: 'primary', size: 'small', disabled: (params.row.$select_value==null && o.valueAll && o.valueAll.defaultFlag === 1) || o.valueAll &&  params.row.$select_value==o.valueAll.address},
                                    style: {marginRight: '10px'},
                                    on: {
                                        click: () => {
                                            if (!params.row.addressList.length) {
                                                return
                                            }
                                            let sel = null
                                            let list = params.row.addressList
                                            for (let i=0;i<list.length;i++) {
                                                let d = list[i]
                                                if (d.address === params.row.$select_value) {
                                                    sel = d
                                                    break
                                                }
                                            }
                                            if (!sel && list.length) {
                                                sel = list[0]
                                            }
                                            let options = []
                                            let selValue = null
                                            let oldVersion = null
                                            list.forEach((item1) => {
                                                if (item1.defaultFlag == 1) {
                                                    selValue = item1.walletId
                                                    oldVersion = item1.version
                                                }
                                            })
                                            fundApi.setDetail({
                                                oldDefaultWalletId:selValue || null,
                                                newDefaultWalletId:  sel && sel.walletId,
                                                oldVersion:oldVersion || null,
                                                newVersion: sel && sel.version
                                            }, () => {
                                                this.$Message.success({content: '设置成功'})
                                                this.getAllColdWallet()
                                            }, (msg) => {
                                                this.$Message.error({content: msg})
                                            })
                                        }
                                    }
                                }, '设为默认'),
                                h('Button', {
                                    props: {type: 'primary', size: 'small'},
                                    style: {marginRight: '10px'},
                                    on: {
                                        click: () => {
                                            let selItem = null
                                            let list = params.row.addressList
                                            for(let i=0;i<list.length;i++){
                                                let d = list[i]
                                                if (d.address === params.row.$select_value) {
                                                    selItem = d
                                                    break
                                                } else if (d.defaultFlag == 1) {
                                                    selItem = d
                                                    break
                                                }
                                            }
                                            if (!selItem) {
                                                this.$Message.error({content: '请选择默认地址'})
                                            } else {
                                                util.setDialog(updataWaletAddress, {
                                                    item: selItem,
                                                    okCallback: () => {
                                                        this.getAllColdWallet()
                                                    }
                                                })
                                            }
                                        }
                                    }
                                }, '修改'),
                                h('Button', {
                                    props: {type: 'primary', size: 'small'},
                                    style: {marginRight: '10px'},
                                    on: {
                                        click: () => {
                                            util.setDialog(addAddress, {
                                                symbol: params.row.symbol,
                                                symbolType: params.row.symbolType,
                                                okCallback: () => {
                                                    this.getAllColdWallet()
                                                }
                                            })
                                        }
                                    }
                                }, '新增地址'),
                                // h('Button', {
                                //     props: {type: 'primary', size: 'small'},
                                //     style: {marginRight: '10px'},
                                //     on: {
                                //         click: () => {
                                //             if (!params.row.addressList.length) {
                                //                 return
                                //             }
                                //             let o = this.detail(params.row.addressList, h)
                                //             o = o.valueAll
                                //             if (!o) {
                                //                 o = params.row.addressList[0]
                                //             }
                                //             if (!o.walletId) {
                                //                 return
                                //             }
                                //             fundApi.deleteColdWallet({
                                //                 walletId: o.walletId
                                //             }, (res) => {
                                //                 this.$Message.success({content: '删除成功'})
                                //                 this.getAllColdWallet()
                                //             })
                                //         }
                                //     }
                                // }, '删除地址')
                            ]);
                        }
                    }
                ],
                data1: [],
                symbol: ''
            }
        },
        created () {
            this.getAllColdWallet()
        },
        methods: {
            switchStaus(state) { 
                switch(state){// 0: 未处理  1:已处理  2：已取消  3：已审核
                case 1:
                    return 'BTC'
                    break;
                case 2:
                    return 'ETH'
                    break;
                case 3:
                    return 'OMNI'
                    break;
                case 4:
                    return 'MBT'
                    break;
                }
            },
            detail (addressList, h) {
                let options = []
                let selValue = null
                let valueAll = null
                let abled = false
                addressList.forEach((item) => {
                    if (item.defaultFlag == 1) {
                        selValue = item.address
                        valueAll = item
                    }
                    if (item.address === null) {
                        abled = true
                    } else {
                        options.push(h('Option', {
                            props: {value: item.address, label: item.address}
                        }))
                    }
                    
                })
                return {
                    options: options,
                    selValue: selValue,
                    valueAll: valueAll,
                    abled: abled
                }
            },
            add () {
                util.setDialog(addWallet, {
                    okCallback: () => {
                        this.getAllColdWallet()
                    }
                })
            },
            getAllColdWallet () {
                fundApi.findAllColdWallet(this.curPage, (res, total) => {
                    res.forEach((item) => {
                        item.$select_value = null
                    })
                    this.total = total
                    this.data1 = res
                })
            },
            changePage (page) {
                this.curPage = page
                this.getAllColdWallet()
            }
        }
    }
</script>
<style scoped>
.ivu-card-head p{display: flex;justify-content:space-between;height: 30px;}
</style>
